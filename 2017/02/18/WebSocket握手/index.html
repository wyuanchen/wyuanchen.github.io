<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>WebSocket握手 | wYuan&#39;s Blog</title>
	<link rel="stylesheet" href="/css/style.css" />
	
</head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/archives" class="header__link">Archive</a>
			
				<a href="/tags" class="header__link">Tags</a>
			
				<a href="/categories" class="header__link">Categories</a>
			
		</nav>
		<h1 class="header__title"><a href="/">wYuan&#39;s Blog</a></h1>
		<h2 class="header__subtitle">Enjoy the world</h2>
	</header>

	<main>
		<article>
	
		<h1>WebSocket握手</h1>
	
	<div class="article__infos">
		<span class="article__date">2017-02-18</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/网络协议/">网络协议</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/WebSocket/">WebSocket</a>
			</span>
		
	</div>

	

	
		<h3 id="WebSocket是基于HTTP协议的，具体建立连接的过程如下："><a href="#WebSocket是基于HTTP协议的，具体建立连接的过程如下：" class="headerlink" title="WebSocket是基于HTTP协议的，具体建立连接的过程如下："></a>WebSocket是基于HTTP协议的，具体建立连接的过程如下：</h3><ol>
<li>TCP三次握手建立一个连接    </li>
<li>发生HTTP协议的握手请求，请求把协议升级为WebSocket       </li>
<li>服务端接收到握手请求后，返回HTTP响应允许协议升级为WebSocket       </li>
<li>客户端和服务端在该连接中以后都用WebSocket协议发生信息和接受信息      </li>
<li>关闭TCP连接    </li>
</ol>
<h3 id="WebSocket握手请求"><a href="#WebSocket握手请求" class="headerlink" title="WebSocket握手请求"></a>WebSocket握手请求</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GET /chat HTTP/1.1</div><div class="line">Host: server.example.com</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==</div><div class="line">Sec-WebSocket-Protocol: chat, superchat</div><div class="line">Sec-WebSocket-Version: 13</div><div class="line">Origin: http://example.com</div><div class="line">```         </div><div class="line"></div><div class="line"><span class="comment">&lt;!-- more --&gt;</span></div><div class="line"></div><div class="line">#### 相关字段解释</div></pre></td></tr></table></figure>
<p>Upgrade: websocket<br>Connection: Upgrade<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="bullet">- </span>告诉服务器我请求用WebSocket协议</div></pre></td></tr></table></figure></p>
<p>Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==<br>Sec-WebSocket-Protocol: chat, superchat<br>Sec-WebSocket-Version: 13<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- `Sec-WebSocket-Key` 是一个Base64 encode的值，这个是浏览器随机生成的      </div><div class="line">服务端并不需要将这个值进行反编码，只需要将客户端传来的这个值首先去除首尾的空白，然后和一段固定的 GUID RFC4122 字符串进行连接，固定的 GUID 字符串为 <span class="number">258</span>EAFA5-E914<span class="number">-47</span>DA<span class="number">-95</span>CA-C5AB0DC85B11。连接后的结果使用 SHA<span class="number">-1</span>（<span class="number">160</span>数位）FIPS<span class="number">.180</span><span class="number">-3</span> 进行一个哈希操作，对哈希操作的结果，采用 base64 进行编码，然后作为服务端响应握手的一部分返回给浏览器。    </div><div class="line"></div><div class="line">一个具体的例子：</div><div class="line"></div><div class="line"><span class="number">1.</span> 客户端握手请求中的 `Sec-WebSocket-Key` 头字段的值为 `dGhlIHNhbXBsZSBub25jZQ==`   </div><div class="line"><span class="number">2.</span> 服务端在解析了握手请求的头字段之后，得到 `Sec-WebSocket-Key` 字段的内容为 `dGhlIHNhbXBsZSBub25jZQ==`，注意前后没有空白     </div><div class="line"><span class="number">3.</span> 将 `dGhlIHNhbXBsZSBub25jZQ==` 和一段固定的 GUID 字符串进行连接，新的字符串为 `dGhlIHNhbXBsZSBub25jZQ==<span class="number">258</span>EAFA5-E914<span class="number">-47</span>DA<span class="number">-95</span>CA-C5AB0DC85B11`。   </div><div class="line"><span class="number">4.</span> 使用 SHA<span class="number">-1</span> 哈希算法对上一步中新的字符串进行哈希。得到哈希后的内容为（使用 <span class="number">16</span> 进制的数表示每一个字节中内容）：`<span class="number">0xb3</span> <span class="number">0x7a</span> <span class="number">0x4f</span> <span class="number">0x2c</span> <span class="number">0xc0</span> <span class="number">0x62</span> <span class="number">0x4f</span> <span class="number">0x16</span> <span class="number">0x90</span> <span class="number">0xf6</span> <span class="number">0x46</span> <span class="number">0x06</span> <span class="number">0xcf</span> <span class="number">0x38</span> <span class="number">0x59</span> <span class="number">0x45</span> <span class="number">0xb2</span> <span class="number">0xbe</span> <span class="number">0xc4</span> <span class="number">0xea</span>`     </div><div class="line"><span class="number">5.</span> 对上一步得到的哈希后的字节，使用 `base64` 编码，得到最后的字符串`s3pPLMBiTxaQ9kYGzzhZRbK+xOo=`       </div><div class="line"><span class="number">6.</span> 最后得到的字符串，需要放到服务端响应客户端握手的头字段 `Sec-WebSocket-Accept` 中。        </div><div class="line"></div><div class="line"></div><div class="line">- `Sec_WebSocket-Protocol` 是一个用户定义的字符串，用来区分同URL下，不同的服务所需要的子协议。   </div><div class="line">- `Sec-WebSocket-Version` 是告诉服务器所使用的Websocket Draft（协议版本）   </div><div class="line"></div><div class="line">### WebSocket握手的响应</div></pre></td></tr></table></figure></p>
<p>HTTP/1.1 101 Switching Protocols<br>Upgrade: websocket<br>Connection: Upgrade<br>Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=<br>Sec-WebSocket-Protocol: chat<br>```   </p>
<p>由服务端告诉客户端即将升级的是WebSocket协议。<br>然后，<code>Sec-WebSocket-Accept</code> 这个则是经过服务器确认，并且加密过后的 <code>Sec-WebSocket-Key</code>。<br><code>Sec-WebSocket-Protocol</code> 则是表示最终使用的协议     </p>
<p><strong>只有握手还是走HTTP结束，在握手结束后的通信全都是走WebSocket协议，不是HTTP了。</strong>           </p>

	

	
		<span class="different-posts"><a href="/2017/02/18/WebSocket握手/" onclick="window.history.go(-1); return false;">⬅️ Go back </a></span>

	

</article>

	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<p>Hi there, <br />welcome to my Blog glad you found it. Have a look around, will you?</p>
</div>

	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>© 2017 Wenyuan Chen | Powered by <a href="https://hexo.io/">Hexo</a> | Theme <a href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a></span>
		</div>

	</div>


</footer>



</body>

</html>
